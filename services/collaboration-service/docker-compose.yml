services:
  # ----------------------------------------------------------------------
  # Production Service (Profile: prod)
  # ----------------------------------------------------------------------
  collaboration-service-prod:
    # Only runs when the 'prod' profile is explicitly active
    profiles: ["prod"]
    build:
      context: .
      dockerfile: Dockerfile
    container_name: collaboration-service-prod
    ports:
      - "8000:8000"
    environment:
      - COLLAB_CORS_ORIGINS=${COLLAB_CORS_ORIGINS}
      - CODE_EXEC_SERVICE_URL=${CODE_EXEC_SERVICE_URL}
      - COLLAB_REDIS_HOST=${COLLAB_REDIS_HOST}
      - COLLAB_REDIS_PORT=${COLLAB_REDIS_PORT}
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    depends_on:
      redis-collab:
        condition: service_started

  # ----------------------------------------------------------------------
  # Development Service (Profile: dev)
  # ----------------------------------------------------------------------
  collaboration-service-dev:
    # Only runs when the 'dev' profile is explicitly active
    profiles: ["dev"]
    build:
      context: .
      dockerfile: Dockerfile
    container_name: collaboration-service-dev
    ports:
      - "8000:8000"
    environment:
      - COLLAB_CORS_ORIGINS=${COLLAB_CORS_ORIGINS}
      - CODE_EXEC_SERVICE_URL=${CODE_EXEC_SERVICE_URL}
      - COLLAB_REDIS_HOST=${COLLAB_REDIS_HOST}
      - COLLAB_REDIS_PORT=${COLLAB_REDIS_PORT}
    volumes:
      - .:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    depends_on:
      redis-collab:
        condition: service_started

  redis-collab:
    image: redis:latest
    container_name: redis-collab
    command: ["redis-server"]

  # ----------------------------------------------------------------------
  # Yjs WebSocket Server (Shared - No Profile)
  #    This service runs in both dev and prod environments by default.
  # ----------------------------------------------------------------------
  y-websocket-server:
    image: alokinplc/y-websocket:latest
    container_name: y-websocket-server
    ports:
      - "1234:1234"

  
