services:
  # ----------------------------------------------------------------------
  # Production Service (Profile: prod)
  # ----------------------------------------------------------------------
  collaboration-service-prod:
    # Only runs when the 'prod' profile is explicitly active
    profiles: ["prod"]
    build:
      context: .
      dockerfile: Dockerfile
    image: collaboration-service:latest
    container_name: collaboration-service-prod
    ports:
      - "8000:8000"
    environment:
      - COLLAB_CORS_ORIGINS=${COLLAB_CORS_ORIGINS}
      - CODE_EXEC_SERVICE_URL=${CODE_EXEC_SERVICE_URL}
      - COLLAB_REDIS_HOST=${COLLAB_REDIS_HOST}
      - COLLAB_REDIS_PORT=${COLLAB_REDIS_PORT}
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    depends_on:
      redis-collab:
        condition: service_started

  # ----------------------------------------------------------------------
  # Development Service (Profile: dev)
  # ----------------------------------------------------------------------
  collaboration-service-dev:
    # Only runs when the 'dev' profile is explicitly active
    profiles: ["dev"]
    build:
      context: .
      dockerfile: Dockerfile
    container_name: collaboration-service-dev
    ports:
      - "8000:8000"
    environment:
      - COLLAB_CORS_ORIGINS=${COLLAB_CORS_ORIGINS}
      - CODE_EXEC_SERVICE_URL=${CODE_EXEC_SERVICE_URL}
      - COLLAB_REDIS_HOST=${COLLAB_REDIS_HOST}
      - COLLAB_REDIS_PORT=${COLLAB_REDIS_PORT}
    volumes:
      - .:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    depends_on:
      redis-collab:
        condition: service_started

  redis-collab:
    image: redis:latest
    container_name: redis-collab
    command: ["redis-server"]

  # ----------------------------------------------------------------------
  # PeerJS Server (Shared - No Profile)
  #    This service runs in both dev and prod environments by default.
  # ----------------------------------------------------------------------
  peerjs-server:
    image: peerjs/peerjs-server:latest
    container_name: peerjs-server
    ports:
      - "9000:9000"
    command: peerjs --port 9000 --key peerjs --allow_discovery

  y-redis:
    build:
      context: ../y-redis
      dockerfile: Dockerfile
    container_name: y-redis-server
    ports:
      - "3002:3002"
    command: node ./bin/server.js --no-colors
    environment:
      - REDIS=${REDIS}
      - AUTH_PERM_CALLBACK=${AUTH_PERM_CALLBACK}
      - AUTH_PUBLIC_KEY=${AUTH_PUBLIC_KEY}
      - AUTH_PRIVATE_KEY=${AUTH_PRIVATE_KEY}
    depends_on:
      redis-collab:
        condition: service_started
